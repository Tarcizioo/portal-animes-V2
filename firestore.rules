rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Validate String Length
    function isValidString(text, min, max) {
      return text is string && text.size() >= min && text.size() <= max;
    }

    // Validate Optional String (allows null or string within limits)
    function isOptionalString(text, max) {
      return text == null || (text is string && text.size() <= max);
    }

    // Validate Integer Range
    function isValidInt(num, min, max) {
      return num is int && num >= min && num <= max;
    }

    // Validate Enum (Check if value is in a list)
    function matchesOneOf(value, options) {
      return value in options;
    }

    // Check specifically if the document itself is public (for users)
    // Note: Checks the 'isPublic' boolean field on the resource being read.
    function isResourcePublic() {
      return resource.data.isPublic != false;
    }
    
    // Check if a specific user's profile is public (requires a get() call)
    function isUserPublic(userId) {
       let userDoc = get(/databases/$(database)/documents/users/$(userId));
       return userDoc.data.isPublic != false;
    }

    // --- USERS COLLECTION ---
    match /users/{userId} {
      // GET (single doc): Owner can read everything. Others can read if profile is public.
      allow get: if isOwner(userId) || isResourcePublic();
      
      // LIST (queries/search): Authenticated users can query the users collection.
      // Client-side filters out private profiles (isPublic !== false).
      allow list: if isAuthenticated();
      
      // WRITE: Only Owner can update their profile.
      allow write: if isOwner(userId);

      // --- SUBCOLLECTIONS ---

      // 1. Library (Anime/Manga List)
      match /library/{docId} {
        // READ: Owner OR if Parent User Profile is Public
        allow read: if isOwner(userId) || isUserPublic(userId);
        
        // WRITE: Only Owner
        allow write: if isOwner(userId)
                     && (request.resource.data.score == null || isValidInt(request.resource.data.score, 0, 10))
                     && (request.resource.data.status == null || matchesOneOf(request.resource.data.status, ['watching', 'completed', 'plan_to_watch', 'dropped', 'paused']))
                     && (request.resource.data.currentEp == null || request.resource.data.currentEp >= 0);
      }
      
      // 2. Favorite Characters
      match /favorite_characters/{docId} {
        allow read: if isOwner(userId) || isUserPublic(userId);
        allow write: if isOwner(userId) 
                     && isValidString(request.resource.data.name, 1, 100);
      }

      // 3. Notifications (PRIVATE)
      match /notifications/{notifId} {
        allow read, write: if isOwner(userId);
      }
      
      // Default: Private
      match /{document=**} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // --- COMMENTS --
    match /comments/{commentId} {
      // READ: Public
      allow read: if true;
      
      // CREATE: Authenticated users, MUST use their own Auth UID
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && isValidString(request.resource.data.content, 1, 500)
                    && request.resource.data.createdAt == request.time;
                    
      // UPDATE/DELETE: Only the author can modify/delete
      // Note: We don't typically allow updating comment CONTENT in this app, but if we did/do:
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == request.auth.uid // Cannot change ownership
                    && isValidString(request.resource.data.content, 1, 500);

      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }
}
