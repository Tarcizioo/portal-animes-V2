import{r as m}from"./vendor-C_qnnqqA.js";import{u as F,d as i}from"./index-CMIBCG0R.js";import{v as S,w as R,y as L,l as n,A as c,k as D,t as d,q as I}from"./firebase-Db2SPaPN.js";function C(){const{user:s}=F(),[l,y]=m.useState([]),[v,f]=m.useState(!0);m.useEffect(()=>{if(!s){y([]),f(!1);return}const t=S(i,"users",s.uid,"library"),o=R(t),r=L(o,e=>{const a=e.docs.map(u=>({id:parseInt(u.id),...u.data()}));y(a),f(!1)},e=>{console.error("Erro ao buscar biblioteca:",e),f(!1)});return()=>r()},[s]);const g=async(t,o="plan_to_watch")=>{if(s)try{const r=t.id||t.mal_id;if(!r){console.error("ID do anime inválido:",t);return}const e=n(i,"users",s.uid,"library",r.toString()),a={id:r,title:t.title,image:t.images?.jpg?.image_url||t.image,totalEp:t.episodes||0,currentEp:0,status:o,score:0,lastUpdated:d()};await I(e,a,{merge:!0})}catch(r){throw console.error("Erro ao adicionar anime:",r),r}},b=async(t,o,r)=>{if(s){o<0&&(o=0),r>0&&o>r&&(o=r);try{const e=n(i,"users",s.uid,"library",t.toString()),a={currentEp:o,lastUpdated:d()};r>0&&o===r?a.status="completed":r>0&&o<r,await c(e,a)}catch(e){console.error("Erro ao atualizar progresso:",e)}}},h=(t,o,r)=>b(t,o+1,r),w=async(t,o,r=0)=>{if(s)try{const e=n(i,"users",s.uid,"library",t.toString()),a={status:o,lastUpdated:d()};o==="completed"&&r>0&&(a.currentEp=r),await c(e,a)}catch(e){console.error("Erro ao atualizar status:",e)}},p=async(t,o)=>{if(s)try{const r=n(i,"users",s.uid,"library",t.toString());await c(r,{score:o,lastUpdated:d()})}catch(r){console.error("Erro ao atualizar nota:",r)}};return{library:l,loading:v,addToLibrary:g,incrementProgress:h,updateProgress:b,updateStatus:w,updateRating:p,updateRating:p,removeFromLibrary:async t=>{if(s)try{await D(n(i,"users",s.uid,"library",t.toString()))}catch(o){console.error("Erro ao remover anime:",o)}},toggleFavorite:async t=>{if(!s)throw new Error("Usuário não autenticado");const o=t.id||t.mal_id,r=l.find(a=>a.id===o),e=r?.isFavorite;if(!e&&l.filter(u=>u.isFavorite).length>=3)throw new Error("Você já possui 3 favoritos. Remova um para adicionar outro.");try{const a=n(i,"users",s.uid,"library",o.toString());r?await c(a,{isFavorite:!e}):(await g(t),await c(a,{isFavorite:!0}))}catch(a){throw console.error("Erro ao alterar favorito:",a),a}}}}export{C as u};
