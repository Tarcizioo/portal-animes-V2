import{r as b}from"./vendor-CzuZ2vSz.js";import{u as S,d as c}from"./index-CPSkf6_A.js";import{v as D,w as L,y as R,l as d,B as m,k as _,t as f,n as j,q as T}from"./firebase-sbJdvLJZ.js";function E(){const{user:n}=S(),[l,v]=b.useState([]),[F,p]=b.useState(!0);b.useEffect(()=>{if(!n){v([]),p(!1);return}const r=D(c,"users",n.uid,"library"),e=L(r),s=R(e,o=>{const t=o.docs.map(i=>({id:parseInt(i.id),...i.data()}));v(t),p(!1)},o=>{console.error("Erro ao buscar biblioteca:",o),p(!1)});return()=>s()},[n?.uid]);const g=async(r,e="plan_to_watch")=>{if(n)try{const s=r.id||r.mal_id;if(!s){console.error("ID do anime inválido:",r);return}const o=d(c,"users",n.uid,"library",s.toString()),t=await j(o),i=t.exists(),u=i?t.data():{},a={id:s,title:r.title,image:r.images?.jpg?.image_url||r.image,totalEp:r.episodes||0,currentEp:e==="completed"&&(r.episodes||0)>0?r.episodes||0:i?u.currentEp:0,score:i&&u.score||0,status:e,lastUpdated:f(),genres:[...r.genres||[],...r.themes||[],...r.demographics||[]].map(y=>y.name),year:r.year||r.aired?.prop?.from?.year||null,season:r.season||null,type:r.type||"TV",synopsis:r.synopsis||"",studios:r.studios?r.studios.map(y=>y.name):[],members:r.members||0,isFavorite:i&&u.isFavorite||!1};await T(o,a,{merge:!0})}catch(s){throw console.error("Erro ao adicionar anime:",s),s}},w=async(r,e,s)=>{if(n){e<0&&(e=0),s>0&&e>s&&(e=s);try{const o=d(c,"users",n.uid,"library",r.toString()),t={currentEp:e,lastUpdated:f()};s>0&&e===s?t.status="completed":s>0&&e<s,await m(o,t)}catch(o){console.error("Erro ao atualizar progresso:",o)}}};return{library:l,loading:F,addToLibrary:g,incrementProgress:(r,e,s)=>w(r,e+1,s),updateProgress:w,updateStatus:async(r,e,s=0)=>{if(n)try{const o=d(c,"users",n.uid,"library",r.toString()),t={status:e,lastUpdated:f()};e==="completed"&&s>0&&(t.currentEp=s),await m(o,t)}catch(o){console.error("Erro ao atualizar status:",o)}},updateRating:async(r,e)=>{if(n)try{const s=d(c,"users",n.uid,"library",r.toString());await m(s,{score:e,lastUpdated:f()})}catch(s){console.error("Erro ao atualizar nota:",s)}},removeFromLibrary:async r=>{if(n)try{await _(d(c,"users",n.uid,"library",r.toString()))}catch(e){console.error("Erro ao remover anime:",e)}},toggleFavorite:async r=>{if(!n)throw new Error("Usuário não autenticado");const e=r.id||r.mal_id,s=l.find(t=>t.id===e),o=s?.isFavorite;if(!o&&l.filter(i=>i.isFavorite).length>=6)throw new Error("Você já possui 6 favoritos. Remova um para adicionar outro.");try{const t=d(c,"users",n.uid,"library",e.toString());s?await m(t,{isFavorite:!o}):(await g(r),await m(t,{isFavorite:!0}))}catch(t){throw console.error("Erro ao alterar favorito:",t),t}},syncLibraryData:async r=>{if(!n||!l.length)return;const e=l.filter(t=>{const i=!!t.synopsis,u=Array.isArray(t.genres);return!i||!u});if(e.length===0)return 0;let s=0;const o=e.length;for(const t of e)try{await new Promise(h=>setTimeout(h,600));const i=await fetch(`https://api.jikan.moe/v4/anime/${t.id}/full`);if(!i.ok){i.status===429&&await new Promise(h=>setTimeout(h,2e3));continue}const a=(await i.json()).data,y={id:a.mal_id,title:a.title_english||a.title,image:a.images?.jpg?.image_url,episodes:a.episodes,year:a.year||a.aired?.prop?.from?.year,season:a.season,type:a.type,synopsis:a.synopsis,studios:a.studios,genres:a.genres,themes:a.themes,demographics:a.demographics,members:a.members,score:a.score};await g(y,t.status),s++,r&&r(s,o)}catch(i){console.error(`Falha ao sync anime ${t.id}:`,i)}}}}export{E as u};
